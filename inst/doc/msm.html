<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Marginal Structural Model</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Marginal Structural Model</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(trtswitch)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The Marginal structural model (MSM), introduced by Robins et
al. (2000) and Hernan et al. (2000), provides a principled approach to
adjust for time-dependent confounding in treatment switching using
inverse probability of treatment weighting (IPTW), which creates a
pseudo-population where treatment switching is independent of measured
covariates. Unlike the IPCW method, MSM does not censor data after
treatment switching, and it can be used to estimate the effect of
subsequent therapy in addition to the effect of randomized treatment.
Provided that prognostic covariates for treatment switching and survival
are collected at baseline and at regular intervals, MSM can be more
powerful than IPCW for estimating the effect of randomized
treatment.</p>
</div>
<div id="estimation-of-weights" class="section level1">
<h1>Estimation of weights</h1>
<p>The switching model can be implemented using pooled logistic
regression.</p>
<ul>
<li><p><strong>Visit-Specific Intercepts</strong>: These can be modeled
using a natural cubic spline with specified degrees of freedom, denoted
as <span class="math inline">\(\nu\)</span> (corresponding to the
<code>ns_df</code> parameter of the <code>msm</code> function). The
boundary and internal knots can be based on the range and percentiles of
observed treatment switching times, respectively. Here, <span class="math inline">\(\nu\)</span> equals the number of internal knots
plus one; a value of <span class="math inline">\(\nu=0\)</span>
indicates a common intercept, while <span class="math inline">\(\nu=1\)</span> leads to a linear effect of visit.
By default, <span class="math inline">\(\nu=3\)</span>, which implies
two internal knots for the cubic spline.</p></li>
<li><p><strong>Stratification Factors</strong>: If more than one
stratification factor exists, they can be included in the logistic model
either as main effects only
(<code>strata_main_effect_only = TRUE</code>) or as all possible
combinations of the levels of the stratification factors
(<code>strata_main_effect_only = FALSE</code>).</p></li>
<li><p><strong>Handling Nonconvergence</strong>: If the pooled logistic
regression model encounters issues such as complete or quasi-complete
separation, Firth’s bias-reducing penalized likelihood method
(<code>firth = TRUE</code>) can be applied alongside intercept
correction (<code>flic = TRUE</code>) to yield more accurate predicted
probabilities.</p></li>
<li><p><strong>Inverse Probability of Treatment Weighting</strong>: Let
<span class="math inline">\(A_{i,j}\)</span> denote the indicator of
alternative therapy for subject <span class="math inline">\(i\)</span>
in treatment cycle <span class="math inline">\(j\)</span>. We assume
that once a patient switched to an alternative therapy, he/she will stay
on the alternative therapy. Let <span class="math inline">\(X_i\)</span>
denote the baseline covariates for subject <span class="math inline">\(i\)</span> and <span class="math inline">\(L_{i,j}\)</span> denote the time-dependent
covariates for subject <span class="math inline">\(i\)</span> at the
start of cycle <span class="math inline">\(j\)</span>. For the pooled
logistic regression model for treatment switching, the full data will be
used for patients who didn’t switch treatment, while the partial data up
to and including the treatment cycle when the patient switched treatment
will be used for patients who switched treatment. The logistic
regression model is used to estimate <span class="math display">\[P(A_j
= a_{i,j} | A_{j-1} = 0, \bar{L}_{j} = \bar{l}_{i,j}, X = x_i)\]</span>
where <span class="math inline">\(x_i\)</span>, <span class="math inline">\(l_{i,j}\)</span>, and <span class="math inline">\(a_{i,j}\)</span> denote the observed value of
baseline covariates, time-dependent covariates at the start of cycle
<span class="math inline">\(j\)</span>, and alternative therapy status
for cycle <span class="math inline">\(j\)</span> of subject <span class="math inline">\(i\)</span>, respectively. A subject is on
alternative therapy in cycle <span class="math inline">\(j\)</span> if
and only if treatment switching has occurred at the start of that cycle,
which is equivalent to switching having occurred by the end of cycle
<span class="math inline">\(j−1\)</span>. Consequently, lagged values of
time-dependent covariates are often used in the logistic regression
model. Natural cubic splines can be used to model visit-specific
intercepts for the pooled logistic regression model. The unstabilized
weights for subject <span class="math inline">\(i\)</span> for cycle
<span class="math inline">\(t\)</span> are given by <span class="math display">\[w_i(t) = \prod_{j=1}^{t} \frac{1}{P(A_j = a_{i,j}
| \bar{A}_{j-1} = \bar{a}_{i,j-1}, \bar{L}_{j} = \bar{l}_{i,j}, X =
x_i)}\]</span> where, by assumption, <span class="math inline">\(P(A_j =
1 | A_{j-1} = 1) = 1\)</span>, i.e., the weights do not vary after
treatment switching. Accordingly, the IPTW weight equals the inverse
probability of not having switched treatment at the start of the cycle
when <span class="math inline">\(a_{i,j}=0\)</span>, and the inverse
probability of having switched treatment at the start of the cycle when
<span class="math inline">\(a_{i,j}=1\)</span>.</p></li>
</ul>
<div id="stabilized-weights" class="section level2">
<h2>Stabilized Weights</h2>
<p>To address the high variability in “unstabilized” weights,
researchers often opt for “stabilized” weights. The switching model for
stabilized weights involves a model for the numerator of the weight in
addition to the model for the denominator. Typically, the numerator
model mirrors the denominator model but includes only prognostic
baseline variables. Any baseline variables included in the numerator
must be part of the weighted outcome model. Any baseline variables
included in the weighted outcome model must also be part of the
denominator.</p>
</div>
<div id="truncation-of-weights" class="section level2">
<h2>Truncation of Weights</h2>
<p>You can specify weight truncation using the <code>trunc</code> and
<code>trunc_upper_only</code> parameters of the <code>msm</code>
function. The <code>trunc</code> parameter is a number between 0 and 0.5
that represents the fraction of the weight distribution to truncate. The
<code>trunc_upper_only</code> parameter is a flag that indicates whether
to truncate weights only from the upper end of the weight
distribution.</p>
</div>
</div>
<div id="estimation-of-hazard-ratio" class="section level1">
<h1>Estimation of Hazard Ratio</h1>
<p>Once weights have been obtained for each event time in the data set,
we fit a (potentially stratified) Cox proportional hazards model to this
weighted data set to obtain an estimate of the hazard ratio. The Cox
model includes baseline covariates, randomized treatment, and
time-dependent alternative therapy. An interaction between randomized
and alternative treatment can be included when patients from both
treatment arms can switch to alternative therapy. The confidence
interval for the hazard ratio can be derived by bootstrapping the weight
estimation and the subsequent model-fitting process.</p>
</div>
<div id="example-for-pooled-logistic-regression-switching-model" class="section level1">
<h1>Example for Pooled Logistic Regression Switching Model</h1>
<p>First we prepare the data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>sim1 <span class="ot">&lt;-</span> <span class="fu">tssim</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="at">tdxo =</span> <span class="dv">1</span>, <span class="at">coxo =</span> <span class="dv">1</span>, <span class="at">allocation1 =</span> <span class="dv">1</span>, <span class="at">allocation2 =</span> <span class="dv">1</span>,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="at">p_X_1 =</span> <span class="fl">0.3</span>, <span class="at">p_X_0 =</span> <span class="fl">0.3</span>, </span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="at">rate_T =</span> <span class="fl">0.002</span>, <span class="at">beta1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">beta2 =</span> <span class="fl">0.3</span>, </span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">gamma0 =</span> <span class="fl">0.3</span>, <span class="at">gamma1 =</span> <span class="sc">-</span><span class="fl">0.9</span>, <span class="at">gamma2 =</span> <span class="fl">0.7</span>, <span class="at">gamma3 =</span> <span class="fl">1.1</span>, <span class="at">gamma4 =</span> <span class="sc">-</span><span class="fl">0.8</span>,</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  <span class="at">zeta0 =</span> <span class="sc">-</span><span class="fl">3.5</span>, <span class="at">zeta1 =</span> <span class="fl">0.5</span>, <span class="at">zeta2 =</span> <span class="fl">0.2</span>, <span class="at">zeta3 =</span> <span class="sc">-</span><span class="fl">0.4</span>, </span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  <span class="at">alpha0 =</span> <span class="fl">0.5</span>, <span class="at">alpha1 =</span> <span class="fl">0.5</span>, <span class="at">alpha2 =</span> <span class="fl">0.4</span>, </span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  <span class="at">theta1_1 =</span> <span class="sc">-</span><span class="fl">0.4</span>, <span class="at">theta1_0 =</span> <span class="sc">-</span><span class="fl">0.4</span>, <span class="at">theta2 =</span> <span class="fl">0.2</span>,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  <span class="at">rate_C =</span> <span class="fl">0.0000855</span>, <span class="at">accrualIntensity =</span> <span class="dv">20</span><span class="sc">/</span><span class="dv">30</span>, </span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  <span class="at">followupTime =</span> <span class="dv">600</span>, <span class="at">fixedFollowup =</span> <span class="dv">0</span>, <span class="at">days =</span> <span class="dv">30</span>,</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">500</span>, <span class="at">NSim =</span> <span class="dv">100</span>, <span class="at">seed =</span> <span class="dv">314159</span>)</span></code></pre></div>
<p>Given that the observations are collected at regular intervals, we
use a pooled logistic regression switching model. In this model, the
prognostic baseline variable is represented by <code>bprog</code>, while
<code>L</code> serves as a time-dependent covariate. Additionally,
<code>ns1</code>, <code>ns2</code>, and <code>ns3</code> are the three
terms for the natural cubic spline with <span class="math inline">\(\nu=3\)</span> degrees of freedom for
visit-specific intercepts.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">msm</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  sim1[[<span class="dv">1</span>]], <span class="at">id =</span> <span class="st">&quot;id&quot;</span>, <span class="at">tstart =</span> <span class="st">&quot;tstart&quot;</span>, </span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="at">tstop =</span> <span class="st">&quot;tstop&quot;</span>, <span class="at">event =</span> <span class="st">&quot;Y&quot;</span>, <span class="at">treat =</span> <span class="st">&quot;trtrand&quot;</span>, </span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">swtrt =</span> <span class="st">&quot;xo&quot;</span>, <span class="at">swtrt_time =</span> <span class="st">&quot;xotime&quot;</span>, </span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="at">base_cov =</span> <span class="st">&quot;bprog&quot;</span>, <span class="at">numerator =</span> <span class="st">&quot;bprog&quot;</span>, </span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="at">denominator =</span> <span class="fu">c</span>(<span class="st">&quot;bprog&quot;</span>, <span class="st">&quot;L&quot;</span>), </span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="at">ns_df =</span> <span class="dv">3</span>, <span class="at">swtrt_control_only =</span> <span class="cn">TRUE</span>, <span class="at">boot =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>The fits for the denominator and numerator switching models are as
follows.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># denominator switching model fit</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>fit1<span class="sc">$</span>fit_switch[[<span class="dv">1</span>]]<span class="sc">$</span>fit_den<span class="sc">$</span>parest[, <span class="fu">c</span>(<span class="st">&quot;param&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sebeta&quot;</span>, <span class="st">&quot;z&quot;</span>)]</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt;         param        beta    sebeta            z</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&gt; 1 (Intercept) -3.68101349 0.3623806 -10.15786448</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&gt; 2       bprog  0.02169405 0.2398362   0.09045364</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; 3           L  0.35036304 0.2728040   1.28430313</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; 4         ns1 -0.25774949 0.5444454  -0.47341658</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; 5         ns2  0.65961680 0.7229768   0.91236232</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#&gt; 6         ns3  0.05395416 0.6817778   0.07913746</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co"># numerator switching model fit</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>fit1<span class="sc">$</span>fit_switch[[<span class="dv">1</span>]]<span class="sc">$</span>fit_num<span class="sc">$</span>parest[, <span class="fu">c</span>(<span class="st">&quot;param&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sebeta&quot;</span>, <span class="st">&quot;z&quot;</span>)]</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#&gt;         param        beta    sebeta           z</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">#&gt; 1 (Intercept) -3.44467907 0.3054745 -11.2764849</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">#&gt; 2       bprog  0.07952921 0.2362668   0.3366077</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#&gt; 3         ns1 -0.25793955 0.5435290  -0.4745645</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt; 4         ns2  0.70028647 0.7197425   0.9729680</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt; 5         ns3  0.07212922 0.6776669   0.1064376</span></span></code></pre></div>
<p>Since treatment switching is not allowed in the experimental arm, the
weights are identical to 1 for subjects in the experimental group. The
unstabilized and stablized weights for the control group are plotted
below.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># unstabilized weights</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">ggplot</span>(fit1<span class="sc">$</span>data_outcome <span class="sc">%&gt;%</span> <span class="fu">filter</span>(trtrand <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> unstabilized_weight)) <span class="sc">+</span> </span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">&quot;#77bd89&quot;</span>, <span class="at">color=</span><span class="st">&quot;#1f6e34&quot;</span>, <span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;unstabilized weights&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co"># stabilized weights</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">ggplot</span>(fit1<span class="sc">$</span>data_outcome <span class="sc">%&gt;%</span> <span class="fu">filter</span>(trtrand <span class="sc">==</span> <span class="dv">0</span>), </span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> stabilized_weight)) <span class="sc">+</span> </span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill=</span><span class="st">&quot;#77bd89&quot;</span>, <span class="at">color=</span><span class="st">&quot;#1f6e34&quot;</span>, <span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">&quot;stabilized weights&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<p>Now we fit a weighted outcome Cox model and compare the treatment
hazard ratio estimate with the reported.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>fit1<span class="sc">$</span>fit_outcome<span class="sc">$</span>parest[, <span class="fu">c</span>(<span class="st">&quot;param&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sebeta&quot;</span>, <span class="st">&quot;z&quot;</span>)]</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#&gt;     param       beta    sebeta         z</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#&gt; 1 treated -0.4148265 0.1127703 -3.678509</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#&gt; 2   bprog  0.3580433 0.1078070  3.321151</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#&gt; 3 crossed -0.5156190 0.1643849 -3.136657</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>    </span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">exp</span>(fit1<span class="sc">$</span>fit_outcome<span class="sc">$</span>parest[<span class="dv">1</span>, <span class="fu">c</span>(<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)])</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt;        beta     lower    upper</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt; 1 0.6604549 0.5294841 0.823822</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
